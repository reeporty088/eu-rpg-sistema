<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Monitor do Mestre - RPG</title>
    <style>
        :root { --bg: #121212; --card-bg: #41141a; --header-bg: #800000; --text: #ffffff; --npc-bg: #222; --accent: #ffaaaa; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        h1 { text-align: center; color: var(--header-bg); text-transform: uppercase; letter-spacing: 2px; display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px; }
        
        h2.section-title { border-bottom: 2px solid var(--header-bg); padding-bottom: 5px; margin-top: 40px; color: #ccc; font-size: 18px; }

        /* --- CARD DE MUNDO --- */
        .world-card {
            background: linear-gradient(90deg, #1e1e1e 0%, #2a0a0d 100%);
            border: 2px solid #5a1a1f;
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .world-info { display: flex; flex-direction: column; }
        .world-date { font-size: 20px; font-weight: bold; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
        .world-time { font-size: 32px; font-weight: bold; color: white; display: flex; align-items: center; gap: 10px; }
        .weather-badge { background: rgba(0,0,0,0.4); padding: 5px 12px; border-radius: 20px; font-size: 14px; border: 1px solid #555; display: flex; align-items: center; gap: 8px; }
        
        .world-buttons { display: flex; gap: 10px; }

        .btn-calendar {
            background: var(--header-bg);
            color: white;
            border: 1px solid var(--accent);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            transition: 0.3s;
            height: fit-content;
        }
        .btn-calendar:hover { background: #a00000; box-shadow: 0 0 10px var(--header-bg); }
        
        .btn-world-obs {
            background: transparent;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-transform: uppercase;
            transition: 0.3s;
        }
        .btn-world-obs:hover { background: rgba(0, 255, 255, 0.1); box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); }

        /* GRID GERAL */
        #painel-jogadores, #painel-npcs { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        
        /* CARDS JOGADORES */
        .player-card { background: var(--card-bg); border: 2px solid #5a1a1f; border-radius: 15px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); position: relative; }
        .player-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .player-img { width: 55px; height: 55px; border-radius: 50%; border: 2px solid var(--header-bg); background-size: cover; background-position: center; background-color: #222; flex-shrink: 0; }
        .player-info { flex-grow: 1; min-width: 0; }
        .player-info h2 { margin: 0; font-size: 16px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .player-info p { margin: 0; font-size: 11px; color: #ccc; }
        
        .status-bar { height: 18px; background: #222; border-radius: 10px; margin-bottom: 6px; overflow: hidden; border: 1px solid #444; position: relative; }
        .bar-fill { height: 100%; transition: width 0.4s ease; }
        .hp { background: #d32f2f; } .mp { background: #1976d2; } .pa { background: #7b1fa2; }
        .bar-text { position: absolute; width: 100%; text-align: center; font-size: 10px; font-weight: bold; line-height: 18px; text-shadow: 1px 1px 2px #000; z-index: 2; }
        
        .skull-display { text-align: center; font-size: 20px; margin-top: 5px; opacity: 0.8; }
        .skull-icon { opacity: 0.15; filter: grayscale(1); margin: 0 2px; }
        .skull-icon.active { opacity: 1; filter: grayscale(0) drop-shadow(0 0 5px red); color: white; }

        .xp-control { margin-top: 10px; padding-top: 10px; border-top: 1px solid #5a1a1f; display: flex; align-items: center; gap: 5px; }
        .xp-input { background: #222; border: 1px solid #444; color: white; padding: 5px; border-radius: 5px; width: 100%; text-align: center; font-size: 12px; }
        .btn-send { background: #2e7d32; color: white; border: none; border-radius: 5px; width: 30px; height: 28px; font-weight: bold; cursor: pointer; }
        .btn-send:hover { background: #4caf50; }
        .xp-display-mini { font-size: 10px; color: #ccc; margin-left: auto; white-space: nowrap; }

        .controls-row { display: flex; gap: 5px; margin-top: 5px; }
        .btn-small { flex-grow: 1; background: #222; border: 1px solid #555; color: white; border-radius: 4px; font-size: 10px; cursor: pointer; text-transform: uppercase; padding: 4px; transition: 0.2s; }
        .btn-small:hover { background: #444; border-color: #aaa; }
        .btn-obs.active { background: #800000; border-color: #ffaaaa; color: white; }

        /* --- ESTILOS DE NPC --- */
        .npc-card { background: #2a2a2a; border: 1px solid #444; border-radius: 10px; padding: 10px; position: relative; }
        .npc-expand-btn { width: 100%; background: #333; border: none; color: white; padding: 5px; margin-top: 10px; cursor: pointer; font-size: 12px; }
        .npc-details { display: none; padding-top: 10px; border-top: 1px solid #444; margin-top: 10px; }
        .npc-details.open { display: block; }
        .npc-attr-row { display: flex; justify-content: space-around; margin-bottom: 10px; background: #111; padding: 5px; border-radius: 5px; }
        .npc-attr { text-align: center; font-size: 12px; font-weight: bold; }
        .npc-attr span { display: block; color: #aaa; font-size: 10px; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
        .skill-tag { background: #444; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .skill-tag.pos { color: #81c784; border: 1px solid #2e7d32; }
        .skill-tag.neg { color: #e57373; border: 1px solid #c62828; }
        .npc-hab-item { background: rgba(0,0,0,0.2); border-left: 3px solid #666; padding: 5px; margin-bottom: 5px; font-size: 12px; }
        .npc-hab-title { font-weight: bold; color: #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .npc-hab-desc { display: none; color: #ccc; margin-top: 3px; font-size: 11px; white-space: pre-wrap; }
        .npc-hab-desc.open { display: block; }

        /* --- FORMUL√ÅRIO DE NPC --- */
        #form-npc-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        #form-npc-container.open { display: flex; justify-content: center; align-items: flex-start; }
        .npc-form { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 2px solid var(--header-bg); width: 100%; max-width: 600px; margin-top: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .npc-form input, .npc-form textarea { width: 100%; background: #333; border: 1px solid #555; color: white; padding: 8px; border-radius: 5px; box-sizing: border-box; }
        .npc-form label { font-size: 11px; color: #aaa; display: block; margin-bottom: 2px; }
        .skills-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: #222; padding: 10px; border-radius: 5px; margin-bottom: 10px; }
        .skill-input { text-align: center; }
        .hab-list-editor { margin-bottom: 10px; }
        .hab-editor-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: flex-start; }
        .btn-action { width: 100%; padding: 10px; font-weight: bold; cursor: pointer; border-radius: 5px; border: none; margin-top: 10px; }
        .btn-save { background: #2e7d32; color: white; }
        .btn-cancel { background: #c62828; color: white; margin-top: 5px; }
        .btn-add-npc { background: var(--header-bg); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; display: block; margin: 20px auto; }
        .btn-icon { background: #444; border: none; color: white; cursor: pointer; width: 30px; height: 30px; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>üè∞ MONITOR DO MESTRE</h1>
    
    <div class="world-card" id="world_display">
        <div class="world-info">
            <div class="world-date" id="wd_date">CARREGANDO...</div>
            <div class="world-time">
                <span id="wd_time">00:00</span>
                <div class="weather-badge">
                    <span id="wd_weather_icon">‚òÄ</span>
                    <span id="wd_weather_text" style="text-transform: uppercase; font-size: 12px; font-weight: normal;">Normal</span>
                </div>
            </div>
        </div>
        
        <div class="world-buttons">
            <button class="btn-calendar" onclick="window.open('calendario.html', '_blank')">üìÖ Calend√°rio</button>
            <button class="btn-world-obs" onclick="window.open('overlay_world.html', '_blank')">üé• OBS</button>
        </div>
    </div>

    <h2 class="section-title">JOGADORES</h2>
    <div id="painel-jogadores"></div>

    <h2 class="section-title">NPCs & MONSTROS</h2>
    <button class="btn-add-npc" onclick="openNpcForm()">+ CRIAR NOVO NPC</button>
    <div id="painel-npcs"></div>

    <div id="form-npc-container">
        <div class="npc-form">
            <h3 style="text-align:center; margin-top:0;">EDITOR DE NPC</h3>
            <input type="hidden" id="npc_id">
            <div class="form-row">
                <div><label>Nome</label><input type="text" id="npc_name"></div>
                <div><label>Imagem</label><input type="file" id="npc_img_file" accept="image/*"><input type="hidden" id="npc_img_data"></div>
            </div>
            <div class="form-row-3">
                <div><label>Poder</label><input type="number" id="npc_pod" value="0"></div>
                <div><label>Habilidade</label><input type="number" id="npc_hab" value="0"></div>
                <div><label>Resist√™ncia</label><input type="number" id="npc_res" value="0"></div>
            </div>
            <div class="form-row-3">
                <div><label>Vida (Max)</label><input type="number" id="npc_hp" value="10"></div>
                <div><label>Mana (Max)</label><input type="number" id="npc_mp" value="10"></div>
                <div><label>PA (Max)</label><input type="number" id="npc_pa" value="3"></div>
            </div>
            <label>Per√≠cias (Deixe 0 para esconder)</label>
            <div class="skills-grid" id="npc_skills_container"></div>
            <label>Habilidades Gerais <button type="button" class="btn-icon" style="height:20px; width:20px; font-size:10px;" onclick="addHabRow()">+</button></label>
            <div id="hab_editor_list" class="hab-list-editor"></div>
            <button class="btn-action btn-save" onclick="saveNpc()">SALVAR NPC</button>
            <button class="btn-action btn-cancel" onclick="closeNpcForm()">CANCELAR</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, runTransaction, push, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const baseURL = "https://reeporty088.github.io/ed-rpg-fichas/";

    // --- CLIMA ---
    const SEASONS = ["Primavera", "Ver√£o", "Outono", "Inverno"];
    const WEATHER_TYPES = {
        "Primavera": ["Sol", "Nublado", "Nublado", "Chuva", "Tempestade"],
        "Ver√£o":     ["Sol Intenso", "Sol", "Nublado", "Tempestade", "Vendaval"],
        "Outono":    ["Nublado", "Chuva", "Neblina", "Vento", "Seco"],
        "Inverno":   ["Nublado", "Neve Fraca", "Neve Forte", "Vento Gelado", "Nevasca"]
    };
    const WEATHER_ICONS = {
        "Sol": "‚òÄ", "Sol Intenso": "üî•", "Nublado": "‚òÅ", "Chuva": "üåß", 
        "Tempestade": "‚õà", "Neblina": "üå´", "Vento": "üå¨", "Vento Gelado": "üå¨",
        "Seco": "üçÇ", "Neve Fraca": "üå®", "Neve Forte": "‚ùÑ", "Nevasca": "‚òÉ", "Vendaval": "üå™"
    };

    function pseudoRandom(seed) {
        let x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }

    function getWeather(seasonIndex, day, periodIndex) {
        const seasonName = SEASONS[seasonIndex];
        const options = WEATHER_TYPES[seasonName];
        const seed = (seasonIndex * 1000) + (day * 10) + periodIndex; 
        const rand = Math.floor(pseudoRandom(seed) * options.length);
        const name = options[rand];
        return { name: name, icon: WEATHER_ICONS[name] || "‚ùì" };
    }

    // --- LISTENER DO MUNDO ---
    onValue(ref(db, 'world_time'), (snapshot) => {
        const data = snapshot.val();
        if(!data) return;

        document.getElementById('wd_date').innerText = `Anno ${data.year} | ${SEASONS[data.season]} | Dia ${data.day}`;
        
        const h = data.hour.toString().padStart(2, '0');
        const m = data.minute.toString().padStart(2, '0');
        document.getElementById('wd_time').innerText = `${h}:${m}`;

        const weather = getWeather(data.season, data.day, data.period);
        document.getElementById('wd_weather_icon').innerText = weather.icon;
        document.getElementById('wd_weather_text').innerText = weather.name;
    });

    // --- JOGADORES ---
    onValue(ref(db, 'fichas'), (snapshot) => {
        const painel = document.getElementById('painel-jogadores');
        painel.innerHTML = "";
        const fichas = snapshot.val();
        if (!fichas) return;
        Object.keys(fichas).forEach(id => {
            const f = fichas[id];
            const hpAt = parseInt(f.hp_at)||0; const hpMax = parseInt(f.hp_max)||1;
            const mpAt = parseInt(f.mp_at)||0; const mpMax = parseInt(f.mp_max)||1;
            const paAt = parseInt(f.pa_at)||0; const paMax = parseInt(f.pa_max)||1;
            const hpP = Math.min((hpAt/hpMax)*100,100); const mpP = Math.min((mpAt/mpMax)*100,100); const paP = Math.min((paAt/paMax)*100,100);
            const linkFicha = `${baseURL}?p=${id}`; const linkOverlay = `${baseURL}overlay.html?p=${id}`;
            const isStatusMode = f.overlay_mode === 'status';

            const card = document.createElement('div');
            card.className = 'player-card';
            card.innerHTML = `
                <div class="player-header">
                    <div class="player-img" style="background-image: url('${f.char_img || ''}')"></div>
                    <div class="player-info">
                        <h2>${f.char_name || id}</h2>
                        <div class="controls-row">
                            <button class="btn-small" onclick="window.open('${linkFicha}', '_blank')">üìÑ</button>
                            <button class="btn-small" onclick="window.open('${linkOverlay}', '_blank')">üé•</button>
                            <button class="btn-small btn-obs ${isStatusMode ? 'active' : ''}" onclick="toggleOverlay('${id}', '${f.overlay_mode}')">${isStatusMode ? 'üìä' : 'üè∑Ô∏è'}</button>
                        </div>
                    </div>
                </div>
                <div class="status-bar"><div class="bar-text">PV ${hpAt}/${hpMax}</div><div class="bar-fill hp" style="width:${hpP}%"></div></div>
                <div class="status-bar"><div class="bar-text">PM ${mpAt}/${mpMax}</div><div class="bar-fill mp" style="width:${mpP}%"></div></div>
                <div class="status-bar"><div class="bar-text">PA ${paAt}/${paMax}</div><div class="bar-fill pa" style="width:${paP}%"></div></div>
                <div class="skull-display"><span class="skull-icon ${f.skull1 === 'active' ? 'active' : ''}">üíÄ</span><span class="skull-icon ${f.skull2 === 'active' ? 'active' : ''}">üíÄ</span><span class="skull-icon ${f.skull3 === 'active' ? 'active' : ''}">üíÄ</span></div>
                <div class="xp-control"><div class="xp-display-mini">Pts: ${f.xp_pontos||0} | XP: ${f.xp_total||0}</div></div>
                <div class="xp-control"><input type="number" id="input_xp_${id}" placeholder="XP" class="xp-input"><button class="btn-send" onclick="sendXP('${id}')">+</button></div>
            `;
            painel.appendChild(card);
        });
    });

    // --- NPCs ---
    const periciasIds = ['animais', 'arte', 'esporte', 'influencia', 'luta', 'manha', 'maquinas', 'medicina', 'mistica', 'percepcao', 'saber', 'sobrevivencia'];
    const skillContainer = document.getElementById('npc_skills_container');
    periciasIds.forEach(pid => {
        skillContainer.innerHTML += `<div><label>${pid.toUpperCase()}</label><input type="number" id="form_skill_${pid}" class="skill-input" value="0"></div>`;
    });

    onValue(ref(db, 'npcs'), (snapshot) => {
        const painel = document.getElementById('painel-npcs');
        painel.innerHTML = "";
        const npcs = snapshot.val();
        if (!npcs) return;

        Object.keys(npcs).forEach(id => {
            const n = npcs[id];
            let skillHtml = '';
            periciasIds.forEach(pid => {
                const val = n.skills ? (parseInt(n.skills[pid]) || 0) : 0;
                if (val !== 0) {
                    const css = val > 0 ? 'pos' : 'neg';
                    const txt = val > 0 ? `+${val}` : val;
                    skillHtml += `<span class="skill-tag ${css}">${pid.toUpperCase().substr(0,3)} ${txt}</span>`;
                }
            });
            let habHtml = '';
            if (n.habs) {
                n.habs.forEach((h, idx) => {
                    habHtml += `<div class="npc-hab-item"><div class="npc-hab-title" onclick="toggleNpcDesc('${id}_hab_${idx}')"><span>${h.titulo}</span> <span>[${h.teste}]</span></div><div class="npc-hab-desc" id="desc_${id}_hab_${idx}">${h.desc}</div></div>`;
                });
            }

            const card = document.createElement('div');
            card.className = 'player-card npc-card';
            card.innerHTML = `
                <div class="player-header">
                    <div class="player-img" style="background-image: url('${n.img || ''}')"></div>
                    <div class="player-info">
                        <h2>${n.name || 'NPC'}</h2>
                        <div class="controls-row">
                            <button class="btn-small" onclick='editNpc(${JSON.stringify(id)})'>‚úèÔ∏è Editar</button>
                            <button class="btn-small" style="background:#c62828" onclick="deleteNpc('${id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                </div>
                <div class="status-bar"><div class="bar-text">PV ${n.hp}/${n.hp}</div><div class="bar-fill hp" style="width:100%"></div></div>
                <div class="status-bar"><div class="bar-text">PM ${n.mp}/${n.mp}</div><div class="bar-fill mp" style="width:100%"></div></div>
                <button class="npc-expand-btn" onclick="toggleNpcDetails('${id}')">‚ñº DETALHES ‚ñº</button>
                <div id="details_${id}" class="npc-details">
                    <div class="npc-attr-row"><div class="npc-attr">POD<span>${n.pod}</span></div><div class="npc-attr">HAB<span>${n.hab}</span></div><div class="npc-attr">RES<span>${n.res}</span></div><div class="npc-attr" style="color:#aa66cc">PA<span>${n.pa}</span></div></div>
                    <div class="tag-container">${skillHtml || '<span style="color:#666; font-size:10px">Sem per√≠cias</span>'}</div>
                    <div class="npc-hab-list">${habHtml}</div>
                </div>
            `;
            painel.appendChild(card);
        });
    });

    // --- FUN√á√ïES GERAIS ---
    window.openNpcForm = () => {
        document.getElementById('npc_id').value = ""; document.getElementById('npc_name').value = ""; document.getElementById('npc_img_data').value = ""; document.getElementById('npc_img_file').value = "";
        document.getElementById('npc_pod').value = 0; document.getElementById('npc_hab').value = 0; document.getElementById('npc_res').value = 0;
        document.getElementById('npc_hp').value = 10; document.getElementById('npc_mp').value = 10; document.getElementById('npc_pa').value = 3;
        periciasIds.forEach(pid => document.getElementById(`form_skill_${pid}`).value = 0);
        document.getElementById('hab_editor_list').innerHTML = "";
        document.getElementById('form-npc-container').classList.add('open');
    };
    window.closeNpcForm = () => document.getElementById('form-npc-container').classList.remove('open');
    window.addHabRow = (titulo="", teste="", desc="") => {
        const div = document.createElement('div'); div.className = 'hab-editor-row';
        div.innerHTML = `<div style="flex-grow:1"><input type="text" placeholder="Nome" class="hab-row-title" value="${titulo}" style="margin-bottom:2px"><input type="text" placeholder="Teste" class="hab-row-test" value="${teste}" style="margin-bottom:2px"><textarea placeholder="Descri√ß√£o" class="hab-row-desc" rows="2">${desc}</textarea></div><button type="button" class="btn-icon" onclick="this.parentElement.remove()">‚úñ</button>`;
        document.getElementById('hab_editor_list').appendChild(div);
    };
    window.saveNpc = () => {
        const id = document.getElementById('npc_id').value;
        const name = document.getElementById('npc_name').value;
        const img = document.getElementById('npc_img_data').value;
        const pod = parseInt(document.getElementById('npc_pod').value)||0; const hab = parseInt(document.getElementById('npc_hab').value)||0; const res = parseInt(document.getElementById('npc_res').value)||0;
        const hp = parseInt(document.getElementById('npc_hp').value)||10; const mp = parseInt(document.getElementById('npc_mp').value)||10; const pa = parseInt(document.getElementById('npc_pa').value)||3;
        const skills = {}; periciasIds.forEach(pid => { skills[pid] = parseInt(document.getElementById(`form_skill_${pid}`).value) || 0; });
        const habs = []; document.querySelectorAll('.hab-editor-row').forEach(row => { habs.push({ titulo: row.querySelector('.hab-row-title').value, teste: row.querySelector('.hab-row-test').value, desc: row.querySelector('.hab-row-desc').value }); });
        const npcData = { name, img, pod, hab, res, hp, mp, pa, skills, habs };
        if (id) update(ref(db, 'npcs/' + id), npcData).then(closeNpcForm);
        else push(ref(db, 'npcs'), npcData).then(closeNpcForm);
    };
    window.editNpc = (id) => {
        onValue(ref(db, 'npcs/' + id), (snap) => {
            const data = snap.val(); document.getElementById('npc_id').value = id; document.getElementById('npc_name').value = data.name; document.getElementById('npc_img_data').value = data.img || "";
            document.getElementById('npc_pod').value = data.pod; document.getElementById('npc_hab').value = data.hab; document.getElementById('npc_res').value = data.res;
            document.getElementById('npc_hp').value = data.hp; document.getElementById('npc_mp').value = data.mp; document.getElementById('npc_pa').value = data.pa;
            periciasIds.forEach(pid => { document.getElementById(`form_skill_${pid}`).value = data.skills ? (data.skills[pid] || 0) : 0; });
            const habList = document.getElementById('hab_editor_list'); habList.innerHTML = "";
            if (data.habs) data.habs.forEach(h => addHabRow(h.titulo, h.teste, h.desc));
            document.getElementById('form-npc-container').classList.add('open');
        }, { onlyOnce: true });
    };
    window.deleteNpc = (id) => { if(confirm("Deletar NPC?")) remove(ref(db, 'npcs/' + id)); };
    document.getElementById('npc_img_file').addEventListener('change', (e) => {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = (re) => {
            const img = new Image(); img.onload = () => {
                const cvs = document.createElement('canvas'); const max = 300; let w = img.width, h = img.height;
                if(w>h){ if(w>max){h*=max/w; w=max}} else {if(h>max){w*=max/h; h=max}}
                cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h);
                document.getElementById('npc_img_data').value = cvs.toDataURL('image/jpeg', 0.7);
            }; img.src = re.target.result;
        }; reader.readAsDataURL(file);
    });
    window.toggleNpcDetails = (id) => document.getElementById('details_'+id).classList.toggle('open');
    window.toggleNpcDesc = (uid) => document.getElementById('desc_'+uid).classList.toggle('open');
    window.toggleOverlay = (id, currentMode) => { const newMode = currentMode === 'status' ? 'nome' : 'status'; update(ref(db, `fichas/${id}`), { overlay_mode: newMode }); };
    window.sendXP = (id) => { const input = document.getElementById(`input_xp_${id}`); const qtd = parseInt(input.value); if (qtd && qtd > 0) { const xpRef = ref(db, `fichas/${id}/xp_total`); runTransaction(xpRef, (current) => (current || 0) + qtd).then(() => { input.value = ""; }); } };
</script>
</body>
</html>
