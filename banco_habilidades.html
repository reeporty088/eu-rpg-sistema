<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Mestre - Banco de Habilidades</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { max-width: 800px; width: 100%; display: grid; grid-template-columns: 1fr; gap: 20px; }
        
        .card { background: #2a2a2a; padding: 20px; border-radius: 10px; border: 1px solid #444; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        h2 { margin-top: 0; color: #ffaaaa; text-transform: uppercase; text-align: center; border-bottom: 2px solid #800000; padding-bottom: 10px; }
        
        label { display: block; margin-top: 10px; font-weight: bold; color: #ccc; font-size: 14px; }
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; background: #111; border: 1px solid #555; color: white; border-radius: 5px; box-sizing: border-box; }
        textarea { height: 100px; resize: vertical; }
        
        .checkbox-container { display: flex; align-items: center; gap: 10px; margin-top: 15px; background: #333; padding: 10px; border-radius: 5px; border: 1px solid #555; }
        .checkbox-container input { width: auto; margin: 0; }
        
        button { margin-top: 20px; width: 100%; padding: 12px; background: #800000; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.2s; }
        button:hover { background: #a00000; }
        button.cancel-edit { background: #555; margin-top: 10px; }
        button.cancel-edit:hover { background: #777; }

        .hidden { display: none; }
        
        .item-list { margin-top: 20px; max-height: 500px; overflow-y: auto; background: #222; padding: 10px; border-radius: 5px; }
        .db-item { background: #333; padding: 10px; margin-bottom: 5px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #800000; }
        
        .item-info { flex-grow: 1; }
        .item-actions { display: flex; gap: 5px; align-items: center; }
        
        .cost-badge { font-weight: bold; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px; }
        .cost-pos { background: #b71c1c; color: white; } /* Custo (Positivo) */
        .cost-neg { background: #1b5e20; color: white; } /* Redu√ß√£o (Negativo) */
        .cost-var { background: #0288d1; color: white; } /* Vari√°vel */

        .btn-action { width: 30px; height: 30px; margin: 0; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 4px; }
        .btn-view { background: #0088aa; }
        .btn-edit { background: #ff8f00; }
        .btn-del { background: #ff4444; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #2a2a2a; padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; border: 2px solid #800000; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: white; font-size: 20px; cursor: pointer; width: auto; padding: 0; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2 id="form-title">Adicionar ao Banco</h2>
        
        <label>CATEGORIA</label>
        <select id="categoria" onchange="updateForm()">
            <option value="vantagens">Vantagens / Desvantagens (Geral)</option>
            <option value="arquetipo">Arqu√©tipo (Vantagens/Desvantagens)</option>
            <option value="artefatos_mods">Artefatos (B√¥nus e √înus)</option>
            <option value="tecnicas">T√©cnicas</option>
        </select>

        <div id="form-content">
            <label>Nome da Habilidade</label>
            <input type="text" id="nome" placeholder="Ex: L√¢mina Afiada">
        </div>

        <div id="extra-fields"></div>

        <label>Descri√ß√£o</label>
        <textarea id="desc" placeholder="Descreva o efeito..."></textarea>

        <button id="btn-save" onclick="salvarNoBanco()">SALVAR NO BANCO</button>
        <button id="btn-cancel" class="cancel-edit hidden" onclick="cancelEdit()">CANCELAR EDI√á√ÉO</button>
    </div>

    <div class="card">
        <h2>Itens Cadastrados</h2>
        <div class="item-list" id="preview-list">
            <div style="text-align:center; color:#777;">Selecione uma categoria acima para ver os itens.</div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-details" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="close-modal" onclick="closeModal()">‚úñ</button>
        <h3 id="detail-title" style="color:#ffaaaa; border-bottom:1px solid #555; padding-bottom:10px;">Titulo</h3>
        <div id="detail-info" style="margin-bottom:10px; font-size:14px; color:#aaa;">Infos</div>
        <div id="detail-desc" style="white-space: pre-wrap; line-height: 1.5;">Descri√ß√£o completa aqui.</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, push, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let editingKey = null; // Vari√°vel para controlar se estamos editando
    let currentData = {}; // Guarda os dados carregados para o preview

    // Elementos
    const catSelect = document.getElementById('categoria');
    const extraDiv = document.getElementById('extra-fields');
    const nomeInput = document.getElementById('nome');
    const descInput = document.getElementById('desc');
    const btnSave = document.getElementById('btn-save');
    const btnCancel = document.getElementById('btn-cancel');
    const formTitle = document.getElementById('form-title');

    window.updateForm = () => {
        if(editingKey) return; // N√£o atualiza se estiver editando para n√£o perder dados
        renderFormFields(catSelect.value);
        loadPreview();
    };

    function renderFormFields(cat) {
        extraDiv.innerHTML = ""; 

        if (cat === 'vantagens' || cat === 'arquetipo') {
            extraDiv.innerHTML = `
                <label>Custo (Texto)</label>
                <input type="text" id="custo" placeholder="Ex: 2 PT, -1 PT, Gratuito">
            `;
        } 
        else if (cat === 'artefatos_mods') {
            extraDiv.innerHTML = `
                <div style="font-size:12px; color:#aaa; margin-top:5px; margin-bottom:5px;">
                    Custo Positivo = Aumenta valor/custo do item.<br>
                    Custo Negativo = Reduz valor/custo do item.
                </div>
                <div class="checkbox-container">
                    <input type="checkbox" id="is_variable" onchange="toggleCustoInput(this)">
                    <label style="margin:0; cursor:pointer;" for="is_variable">Custo Vari√°vel (Jogador escolhe o valor)</label>
                </div>
                <label id="lbl_custo">Custo do Modificador (N√∫mero)</label>
                <input type="number" id="custo_mod" placeholder="Ex: 10 ou -5">
            `;
        }
        else if (cat === 'tecnicas') {
            extraDiv.innerHTML = `
                <label>Tipo de T√©cnica</label>
                <select id="tipo_tec">
                    <option value="truque">Truque</option>
                    <option value="comum">T√©cnica Comum</option>
                    <option value="lendaria">T√©cnica Lend√°ria</option>
                </select>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Exig√™ncia</label><input type="text" id="exigencia" placeholder="Ex: Espada Nv.1"></div>
                    <div><label>Alcance</label><input type="text" id="alcance" placeholder="Ex: Curto"></div>
                    <div><label>Custo (PM/A√ß√£o)</label><input type="text" id="custo" placeholder="Ex: 2 PM"></div>
                    <div><label>Dura√ß√£o</label><input type="text" id="duracao" placeholder="Ex: Instant√¢neo"></div>
                </div>
            `;
        }
    }

    // Fun√ß√£o auxiliar para Artefatos: Se for vari√°vel, esconde o input de n√∫mero
    window.toggleCustoInput = (chk) => {
        const inp = document.getElementById('custo_mod');
        if(chk.checked) {
            inp.disabled = true;
            inp.placeholder = "Definido pelo Jogador";
            inp.value = "";
        } else {
            inp.disabled = false;
            inp.placeholder = "Ex: 10 ou -5";
        }
    };

    window.salvarNoBanco = () => {
        const cat = catSelect.value;
        const nome = nomeInput.value;
        const desc = descInput.value;

        if(!nome) { alert("O nome √© obrigat√≥rio!"); return; }

        let data = { nome, desc };

        // Coleta de dados baseada na categoria
        if (cat === 'vantagens' || cat === 'arquetipo') {
            data.custo = document.getElementById('custo').value;
        }
        else if (cat === 'artefatos_mods') {
            const isVar = document.getElementById('is_variable').checked;
            data.variavel = isVar;
            if (isVar) {
                data.custo = 0; // Valor placeholder
            } else {
                data.custo = parseFloat(document.getElementById('custo_mod').value) || 0;
            }
        }
        else if (cat === 'tecnicas') {
            data.tipo = document.getElementById('tipo_tec').value;
            data.exigencia = document.getElementById('exigencia').value;
            data.alcance = document.getElementById('alcance').value;
            data.custo = document.getElementById('custo').value;
            data.duracao = document.getElementById('duracao').value;
        }

        // L√≥gica: Criar Novo ou Atualizar Existente
        if (editingKey) {
            // ATUALIZAR
            update(ref(db, `biblioteca_habilidades/${cat}/${editingKey}`), data)
                .then(() => {
                    alert("Atualizado com sucesso!");
                    cancelEdit(); // Sai do modo de edi√ß√£o
                })
                .catch(err => alert("Erro ao atualizar: " + err.message));
        } else {
            // CRIAR NOVO
            push(ref(db, `biblioteca_habilidades/${cat}`), data)
                .then(() => {
                    alert("Salvo com sucesso!");
                    clearForm();
                })
                .catch(err => alert("Erro ao salvar: " + err.message));
        }
    };

    window.cancelEdit = () => {
        editingKey = null;
        formTitle.innerText = "Adicionar ao Banco";
        btnSave.innerText = "SALVAR NO BANCO";
        btnSave.style.background = "#800000";
        btnCancel.classList.add('hidden');
        catSelect.disabled = false; // Destrava categoria
        clearForm();
    };

    function clearForm() {
        nomeInput.value = "";
        descInput.value = "";
        // Limpa campos din√¢micos se existirem
        if(document.getElementById('custo')) document.getElementById('custo').value = "";
        if(document.getElementById('custo_mod')) {
            document.getElementById('custo_mod').value = "";
            document.getElementById('custo_mod').disabled = false;
        }
        if(document.getElementById('is_variable')) document.getElementById('is_variable').checked = false;
        if(document.getElementById('exigencia')) {
            document.getElementById('exigencia').value = "";
            document.getElementById('alcance').value = "";
            document.getElementById('duracao').value = "";
        }
    }

    function loadPreview() {
        const cat = catSelect.value;
        const list = document.getElementById('preview-list');
        list.innerHTML = "<div style='text-align:center; padding:10px;'>Carregando...</div>";

        onValue(ref(db, `biblioteca_habilidades/${cat}`), (snapshot) => {
            list.innerHTML = "";
            currentData = snapshot.val();
            
            if (!currentData) {
                list.innerHTML = "<div style='text-align:center; padding:10px; color:#555;'>Nenhum item nesta categoria.</div>";
                return;
            }

            Object.keys(currentData).forEach(key => {
                const item = currentData[key];
                const div = document.createElement('div');
                div.className = 'db-item';
                
                // Preparar Badge de Custo
                let badgeHTML = "";
                if(cat === 'artefatos_mods') {
                    if (item.variavel) {
                        badgeHTML = `<span class="cost-badge cost-var">VARIAVEL</span>`;
                    } else {
                        const val = item.custo;
                        const css = val >= 0 ? 'cost-pos' : 'cost-neg';
                        const sign = val > 0 ? '+' : '';
                        badgeHTML = `<span class="cost-badge ${css}">${sign}${val}</span>`;
                    }
                } else if (item.custo) {
                    badgeHTML = `<span class="cost-badge" style="background:#444;">${item.custo}</span>`;
                }

                // Info extra para T√©cnicas
                let subInfo = "";
                if (cat === 'tecnicas') {
                    subInfo = `<div style="font-size:11px; color:#888;">${item.tipo.toUpperCase()} | ${item.exigencia || '-'}</div>`;
                }

                div.innerHTML = `
                    <div class="item-info">
                        <div>${item.nome}</div>
                        ${subInfo}
                    </div>
                    <div class="item-actions">
                        ${badgeHTML}
                        <button class="btn-action btn-view" onclick="viewDetails('${key}')" title="Ver Detalhes">üëÅÔ∏è</button>
                        <button class="btn-action btn-edit" onclick="startEdit('${key}')" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-action btn-del" onclick="deleteItem('${key}')" title="Excluir">‚úñ</button>
                    </div>
                `;
                list.appendChild(div);
            });
        });
    }

    // --- FUN√á√ïES GLOBAIS (View, Edit, Delete) ---

    window.viewDetails = (key) => {
        const item = currentData[key];
        document.getElementById('modal-details').style.display = 'flex';
        document.getElementById('detail-title').innerText = item.nome;
        document.getElementById('detail-desc').innerText = item.desc;
        
        let info = "";
        if(item.custo) info += `Custo: ${item.custo} | `;
        if(item.tipo) info += `Tipo: ${item.tipo} | `;
        if(item.variavel) info += `Custo Vari√°vel: SIM | `;
        if(item.exigencia) info += `Exig√™ncia: ${item.exigencia} | `;
        document.getElementById('detail-info').innerText = info;
    };

    window.closeModal = () => {
        document.getElementById('modal-details').style.display = 'none';
    };

    window.startEdit = (key) => {
        const item = currentData[key];
        editingKey = key;

        // UI Updates
        formTitle.innerText = `Editando: ${item.nome}`;
        btnSave.innerText = "ATUALIZAR ITEM";
        btnSave.style.background = "#ff8f00";
        btnCancel.classList.remove('hidden');
        catSelect.disabled = true; // Trava categoria para evitar erros
        
        // Populate Fields
        nomeInput.value = item.nome;
        descInput.value = item.desc;

        if(document.getElementById('custo')) document.getElementById('custo').value = item.custo;
        
        if(document.getElementById('custo_mod')) {
            if(item.variavel) {
                document.getElementById('is_variable').checked = true;
                toggleCustoInput(document.getElementById('is_variable'));
            } else {
                document.getElementById('is_variable').checked = false;
                toggleCustoInput(document.getElementById('is_variable'));
                document.getElementById('custo_mod').value = item.custo;
            }
        }

        if(document.getElementById('tipo_tec')) {
            document.getElementById('tipo_tec').value = item.tipo;
            document.getElementById('exigencia').value = item.exigencia;
            document.getElementById('alcance').value = item.alcance;
            document.getElementById('duracao').value = item.duracao;
        }

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.deleteItem = (key) => {
        if(confirm("Tem certeza que deseja apagar este item?")) {
            const cat = catSelect.value;
            remove(ref(db, `biblioteca_habilidades/${cat}/${key}`));
        }
    };

    // Inicializa
    renderFormFields(catSelect.value);
    loadPreview();

</script>
</body>
</html>
