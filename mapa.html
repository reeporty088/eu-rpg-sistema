<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hexamap World Builder</title>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 300px; height: 100%;
            background: rgba(30, 30, 30, 0.95); border-right: 2px solid #444;
            padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; gap: 10px;
            z-index: 10; box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }

        canvas { display: block; background: #111; cursor: default; }
        
        h2 { margin: 0 0 10px 0; color: #ffaa00; text-transform: uppercase; font-size: 16px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        label { font-size: 12px; color: #aaa; display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; margin-bottom: 10px; }
        
        .btn { background: #444; color: white; border: 1px solid #666; padding: 8px; cursor: pointer; width: 100%; margin-bottom: 5px; font-weight: bold; border-radius: 4px; transition: 0.2s; }
        .btn:hover { background: #666; }
        .btn.active { background: #ffaa00; color: black; border-color: #ffaa00; }

        .tools-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .tool-btn { flex: 1; padding: 10px; font-size: 20px; background: #222; border: 1px solid #555; cursor: pointer; border-radius: 5px; }
        .tool-btn.active { background: #ffaa00; border-color: white; color: black; }

        .palette { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .swatch { width: 100%; aspect-ratio: 1; border: 2px solid #555; cursor: pointer; transition: 0.2s; position: relative; border-radius: 4px; }
        .swatch:hover { border-color: white; transform: scale(1.1); z-index: 2; }
        .swatch.selected { border-color: #ffaa00; box-shadow: 0 0 10px #ffaa00; z-index: 2; }
        
        .info-bar { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 5px 10px; border-radius: 5px; font-size: 12px; pointer-events: none; border: 1px solid #444; }
        
        /* Scrollbar customizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #222; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h2>Ferramentas</h2>
        <div class="tools-row">
            <button class="tool-btn active" id="btnBrush" onclick="setTool('brush')" title="Pintar (B)">üñåÔ∏è</button>
            <button class="tool-btn" id="btnHand" onclick="setTool('hand')" title="Mover (Espa√ßo ou H)">‚úã</button>
        </div>

        <h2>Configura√ß√£o</h2>
        <label>Carregar Mapa Mundi (Imagem)</label>
        <input type="file" id="bgLoader" accept="image/*">
        
        <label>Tamanho do Hex√°gono</label>
        <input type="range" id="hexSize" min="10" max="100" value="30">
        
        <label>Opacidade da Grade</label>
        <input type="range" id="gridOpacity" min="0" max="1" step="0.1" value="0.3">

        <hr style="border:0; border-top:1px solid #444; width:100%;">
        
        <h2>Terrenos</h2>
        <div class="palette" id="palette">
            </div>

        <button class="btn" onclick="clearHexes()">Limpar Tudo</button>
        <button class="btn" style="background:#2e7d32; border-color:#4caf50;" onclick="saveMap()">üíæ Salvar JSON</button>
        <button class="btn" style="background:#1565c0; border-color:#42a5f5;" onclick="loadMap()">üìÇ Carregar JSON</button>
        <input type="file" id="jsonLoader" style="display:none" accept=".json">
        
        <div style="margin-top:auto; font-size:11px; color:#666; text-align:center;">
            Segure ESPA√áO para arrastar enquanto pinta.<br>
            Roda do mouse para Zoom.
        </div>
    </div>

    <canvas id="mapCanvas"></canvas>
    <div class="info-bar" id="coordDisplay">Hex: 0, 0</div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');

    // --- CONFIGURA√á√ÉO GLOBAL ---
    // Camera agora guarda offset (x,y) e zoom
    let camera = { x: 0, y: 0, zoom: 1 };
    
    let activeTool = 'brush'; // 'brush' ou 'hand'
    let isSpacePressed = false;
    let isDragging = false;
    let lastMouse = { x: 0, y: 0 }; // Posi√ß√£o do mouse na tela
    let dragStart = { x: 0, y: 0 }; // Posi√ß√£o inicial do arrasto
    
    let bgImage = null;
    let hexMap = {}; 
    let hexRadius = 30;
    let gridOpacity = 0.3;

    // --- TIPOS DE TERRENO ---
    const TERRAINS = {
        'void': { color: 'transparent', icon: '‚ùå', label: 'Apagar' },
        'ocean': { color: '#1a237e', icon: 'üåä', label: 'Oceano' },
        'coast': { color: '#4fc3f7', icon: 'üíß', label: 'Costa' },
        'grass': { color: '#2e7d32', icon: 'üå±', label: 'Plan√≠cie' },
        'forest': { color: '#1b5e20', icon: 'üå≤', label: 'Floresta' },
        'swamp': { color: '#2e3828', icon: 'üê∏', label: 'P√¢ntano' },
        'desert': { color: '#fbc02d', icon: 'üåµ', label: 'Deserto' },
        'mountain': { color: '#5d4037', icon: '‚õ∞Ô∏è', label: 'Montanha' },
        'snow': { color: '#eceff1', icon: '‚ùÑÔ∏è', label: 'Neve' },
        'city': { color: '#9e9e9e', icon: 'üè∞', label: 'Cidade' },
        'village': { color: '#795548', icon: 'üè†', label: 'Vila' },
        'ruin': { color: '#000000', icon: 'üíÄ', label: 'Ru√≠na' },
        'road': { color: '#ff9800', icon: 'üõ§Ô∏è', label: 'Estrada' },
        'poi': { color: '#d500f9', icon: '‚≠ê', label: 'Interesse' }
    };
    let currentTerrain = 'grass';

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        draw();
    }
    window.addEventListener('resize', resize);
    resize();

    // --- TOOLBAR ---
    function setTool(tool) {
        activeTool = tool;
        document.getElementById('btnBrush').classList.toggle('active', tool === 'brush');
        document.getElementById('btnHand').classList.toggle('active', tool === 'hand');
        canvas.style.cursor = tool === 'hand' ? 'grab' : 'default';
    }

    // --- PALETA ---
    const paletteDiv = document.getElementById('palette');
    Object.keys(TERRAINS).forEach(key => {
        const t = TERRAINS[key];
        const div = document.createElement('div');
        div.className = 'swatch';
        div.style.backgroundColor = t.color === 'transparent' ? '#333' : t.color;
        div.innerHTML = `<span style="font-size:20px">${t.icon}</span>`;
        div.title = t.label;
        div.onclick = () => selectTerrain(key, div);
        if(key === 'grass') div.classList.add('selected');
        paletteDiv.appendChild(div);
    });

    function selectTerrain(key, el) {
        currentTerrain = key;
        document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
        el.classList.add('selected');
        setTool('brush'); // Auto seleciona brush ao clicar na cor
    }

    // --- MATEM√ÅTICA HEXAGONAL ---
    function hexToPixel(q, r) {
        const x = hexRadius * (3/2 * q);
        const y = hexRadius * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r);
        return { x, y };
    }

    function pixelToHex(x, y) {
        const q = (2/3 * x) / hexRadius;
        const r = (-1/3 * x + Math.sqrt(3)/3 * y) / hexRadius;
        return cubeRound(q, -q-r, r);
    }

    function cubeRound(fracQ, fracS, fracR) {
        let q = Math.round(fracQ);
        let s = Math.round(fracS);
        let r = Math.round(fracR);
        const qDiff = Math.abs(q - fracQ);
        const sDiff = Math.abs(s - fracS);
        const rDiff = Math.abs(r - fracR);
        if (qDiff > sDiff && qDiff > rDiff) q = -s - r;
        else if (sDiff > rDiff) s = -q - r;
        else r = -q - s;
        return { q, r };
    }

    // --- CONVERS√ÉO DE COORDENADAS (TELA <-> MUNDO) ---
    function screenToWorld(sx, sy) {
        return {
            x: (sx - canvas.width / 2) / camera.zoom + camera.x,
            y: (sy - canvas.height / 2) / camera.zoom + camera.y
        };
    }

    function worldToScreen(wx, wy) {
        return {
            x: (wx - camera.x) * camera.zoom + canvas.width / 2,
            y: (wy - camera.y) * camera.zoom + canvas.height / 2
        };
    }

    // --- DESENHO ---
    function drawHex(ctx, x, y, size, color, icon, stroke = true) {
        ctx.beginPath();
        for (let i = 0; i < 6; i++) {
            const angle_rad = Math.PI / 180 * (60 * i);
            const px = x + size * Math.cos(angle_rad);
            const py = y + size * Math.sin(angle_rad);
            if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
        }
        ctx.closePath();
        
        if (color && color !== 'transparent') {
            ctx.fillStyle = color;
            ctx.fill();
        }
        
        if (stroke && gridOpacity > 0) {
            ctx.strokeStyle = `rgba(255,255,255,${gridOpacity})`;
            ctx.lineWidth = 1;
            ctx.stroke();
        }

        if (icon) {
            ctx.fillStyle = 'white';
            ctx.font = `${Math.floor(size/1.3)}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            // Sombra para ler melhor em fundo claro
            ctx.shadowColor = "black";
            ctx.shadowBlur = 4;
            ctx.fillText(icon, x, y);
            ctx.shadowBlur = 0;
        }
    }

    function draw() {
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        
        // Aplica transforma√ß√µes da c√¢mera
        ctx.translate(canvas.width / 2, canvas.height / 2);
        ctx.scale(camera.zoom, camera.zoom);
        ctx.translate(-camera.x, -camera.y);

        // 1. Imagem de Fundo
        if (bgImage) {
            // Desenha centralizado no mundo 0,0
            ctx.drawImage(bgImage, -bgImage.width/2, -bgImage.height/2);
        }

        // 2. Hex√°gonos
        for (let key in hexMap) {
            const [q, r] = key.split(',').map(Number);
            const pos = hexToPixel(q, r);
            const data = hexMap[key];
            const terrain = TERRAINS[data.type];
            if (terrain) {
                drawHex(ctx, pos.x, pos.y, hexRadius, terrain.color, terrain.icon, true);
            }
        }

        // 3. Cursor (Hover)
        // Precisamos converter a posi√ß√£o do mouse na tela para o mundo
        const mouseWorld = screenToWorld(lastMouse.x, lastMouse.y);
        const hex = pixelToHex(mouseWorld.x, mouseWorld.y);
        const center = hexToPixel(hex.q, hex.r);
        
        // Desenha o hex√°gono fantasma onde o mouse est√°
        drawHex(ctx, center.x, center.y, hexRadius, 'rgba(255, 255, 255, 0.1)', null, true);
        
        // Atualiza UI
        document.getElementById('coordDisplay').innerText = `Hex: ${hex.q}, ${hex.r} | Zoom: ${(camera.zoom*100).toFixed(0)}%`;

        ctx.restore();
        requestAnimationFrame(draw);
    }

    // --- CONTROLES E INPUTS ---

    // Zoom no Mouse (L√≥gica Corrigida)
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        const zoomIntensity = 0.1;
        const mouseWorldBefore = screenToWorld(e.clientX, e.clientY);
        
        const delta = -Math.sign(e.deltaY);
        const newZoom = camera.zoom * (1 + delta * zoomIntensity);

        // Limites de Zoom
        if (newZoom < 0.1 || newZoom > 10) return;

        camera.zoom = newZoom;
        
        // Ajusta a c√¢mera para que o ponto do mouse continue no mesmo lugar do mundo
        const mouseWorldAfter = screenToWorld(e.clientX, e.clientY);
        
        camera.x += (mouseWorldBefore.x - mouseWorldAfter.x);
        camera.y += (mouseWorldBefore.y - mouseWorldAfter.y);

    }, { passive: false });

    // Mouse Down (In√≠cio da a√ß√£o)
    canvas.addEventListener('mousedown', (e) => {
        const isMiddleClick = e.button === 1;
        const isLeftClick = e.button === 0;

        // Modo Arrastar: Se ferramenta M√£o, ou Espa√ßo segurado, ou bot√£o do meio
        if (activeTool === 'hand' || isSpacePressed || isMiddleClick) {
            isDragging = true;
            dragStart = { x: e.clientX, y: e.clientY };
            canvas.style.cursor = 'grabbing';
        } 
        // Modo Pintar
        else if (isLeftClick && activeTool === 'brush') {
            paintHex(e.clientX, e.clientY);
            isDragging = true; // Reutilizamos flag para "pintar arrastando"
        }
    });

    // Mouse Move (Arrastando ou Movendo)
    canvas.addEventListener('mousemove', (e) => {
        lastMouse = { x: e.clientX, y: e.clientY };

        if (!isDragging) return;

        const isHandMode = (activeTool === 'hand' || isSpacePressed || e.buttons === 4); // 4 = middle mouse

        if (isHandMode) {
            // Mover C√¢mera
            const dx = (e.clientX - dragStart.x) / camera.zoom;
            const dy = (e.clientY - dragStart.y) / camera.zoom;
            camera.x -= dx;
            camera.y -= dy;
            dragStart = { x: e.clientX, y: e.clientY };
        } else {
            // Pintar
            paintHex(e.clientX, e.clientY);
        }
    });

    // Mouse Up
    window.addEventListener('mouseup', () => {
        isDragging = false;
        canvas.style.cursor = (activeTool === 'hand' || isSpacePressed) ? 'grab' : 'default';
    });

    // Teclado (Atalhos)
    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && !isSpacePressed) {
            isSpacePressed = true;
            canvas.style.cursor = 'grab';
        }
        if (e.key.toLowerCase() === 'b') setTool('brush');
        if (e.key.toLowerCase() === 'h') setTool('hand');
    });

    window.addEventListener('keyup', (e) => {
        if (e.code === 'Space') {
            isSpacePressed = false;
            canvas.style.cursor = activeTool === 'hand' ? 'grab' : 'default';
            isDragging = false; // Para de arrastar se soltar espa√ßo
        }
    });

    function paintHex(screenX, screenY) {
        const worldPos = screenToWorld(screenX, screenY);
        const hex = pixelToHex(worldPos.x, worldPos.y);
        const key = `${hex.q},${hex.r}`;

        if (currentTerrain === 'void') {
            delete hexMap[key];
        } else {
            hexMap[key] = { type: currentTerrain };
        }
    }

    // --- ARQUIVOS E SALVAMENTO ---
    document.getElementById('bgLoader').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => { bgImage = img; };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('hexSize').addEventListener('input', (e) => { hexRadius = parseInt(e.target.value); });
    document.getElementById('gridOpacity').addEventListener('input', (e) => { gridOpacity = parseFloat(e.target.value); });

    window.clearHexes = () => { if(confirm('Limpar mapa?')) hexMap = {}; };
    window.saveMap = () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(hexMap));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "hex_world_data.json";
        a.click(); a.remove();
    };
    window.loadMap = () => document.getElementById('jsonLoader').click();
    document.getElementById('jsonLoader').addEventListener('change', (e) => {
        const file = e.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => { hexMap = JSON.parse(evt.target.result); };
        reader.readAsText(file);
    });

    requestAnimationFrame(draw);
</script>
</body>
</html>
