<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ficha RPG - Vers√£o Final</title>
    <style>
        :root { --bg: #1a1a1a; --card-bg: #41141a; --header-bg: #800000; --text: #ffffff; --input-bg: #2a0a0d; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; max-width: 1400px; width: 100%; }
        .col { display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 15px; border: 1px solid #5a1a1f; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .header-label { background: var(--header-bg); text-align: center; border-radius: 20px; padding: 5px; margin-bottom: 15px; font-weight: bold; text-transform: uppercase; display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        input, textarea { background: var(--input-bg); border: 1px solid #555; color: white; padding: 8px; border-radius: 20px; width: 100%; box-sizing: border-box; margin-bottom: 5px; }
        label { font-size: 10px; color: #ffaaaa; font-weight: bold; margin-left: 10px; text-transform: uppercase; display: block; }

        .avatar-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 10px; }
        .avatar-circle { width: 140px; height: 140px; border-radius: 50%; border: 4px solid var(--header-bg); background: #222; overflow: hidden; display: flex; align-items: center; justify-content: center; cursor: pointer; background-size: cover; background-position: center; position: relative; }
        .avatar-circle input[type="file"] { opacity: 0; position: absolute; width: 100%; height: 100%; cursor: pointer; }

        .bar-container { margin-bottom: 10px; }
        .bar-controls { display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.5); border-radius: 25px; padding: 4px 8px; }
        .btn-math { background: transparent; border: none; color: white; cursor: pointer; font-size: 18px; font-weight: bold; width: 30px; z-index: 10; }
        .bar-bg { flex-grow: 1; height: 28px; background: #222; border-radius: 15px; position: relative; overflow: hidden; border: 1px solid #444; display: flex; align-items: center; }
        .bar-fill { position: absolute; left: 0; top: 0; height: 100%; transition: width 0.3s ease; z-index: 1; width: 100%; }
        .hp-fill { background: #d32f2f; } .mp-fill { background: #1976d2; } .pa-fill { background: #7b1fa2; }
        .bar-values { position: relative; z-index: 5; width: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .bar-values input { pointer-events: auto; width: 45px; background: transparent; border: none; text-align: center; font-size: 14px; font-weight: bold; color: white; text-shadow: 1px 1px 2px #000; margin: 0; padding: 0; }

        .hab-item { background: rgba(0,0,0,0.3); border: 1px solid #5a1a1f; border-radius: 10px; margin-bottom: 8px; overflow: hidden; }
        .hab-header { display: flex; align-items: center; padding: 8px; gap: 5px; }
        .hab-title { flex-grow: 1; font-weight: bold; border-radius: 10px !important; margin: 0 !important; }
        .hab-dice { width: 85px !important; text-align: center; border-radius: 10px !important; margin: 0 !important; }
        .hab-toggle { cursor: pointer; color: #ffaaaa; font-size: 12px; padding: 0 5px; }
        .hab-body { padding: 8px; display: none; border-top: 1px solid #5a1a1f; }
        .hab-body.open { display: block; }
        .btn-add { background: #22aa22; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        .btn-del { color: #ff4444; background: transparent; border: none; cursor: pointer; font-weight: bold; font-size: 16px; }

        .marker-section { margin-bottom: 20px; text-align: center; }
        .marker-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 5px; border-radius: 15px; }
        .marker-display { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; min-height: 40px; }
        .marker-item { cursor: pointer; font-size: 24px; opacity: 0.2; transition: 0.3s; filter: grayscale(1); }
        .marker-item.active { opacity: 1; filter: grayscale(0); drop-shadow: 0 0 5px currentColor; }
        .tri { color: #00ffff; } .circ { color: #00ff00; } 
        .btn-count { background: var(--header-bg); border: 1px solid #ffaaaa; color: white; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; line-height: 1; font-weight: bold; }

        .attr-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }
        .attr-box { background: rgba(255,255,255,0.05); border: 1px solid #7a2a2f; border-radius: 12px; padding: 10px 2px; text-align: center; }
        .attr-box input { font-size: 28px; font-weight: bold; text-align: center; border: none; background: transparent; color: white; }
        .pericia-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); margin-bottom: 4px; padding: 5px 15px; border-radius: 20px; border: 1px solid #5a1a1f; }
        .skull { opacity: 0.2; transition: 0.3s; cursor: pointer; font-size: 30px; margin: 0 5px; }
        .skull.active { opacity: 1; filter: drop-shadow(0 0 5px red); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="col">
        <div class="card">
            <div class="header-label">Personagem</div>
            <div class="avatar-container">
                <div class="avatar-circle" id="avatar_display">
                    <input type="file" id="img_upload" accept="image/*">
                </div>
                <input type="text" id="char_name" style="background:transparent; border:none; text-align:center; font-size:18px; font-weight:bold; margin-top:10px; color:white;" placeholder="NOME">
            </div>
            <label>IDADE</label><input type="text" id="idade">
            <label>FLORINS</label><input type="text" id="florins">
            <label>ARQU√âTIPO</label><input type="text" id="arquetipo">
            
            <div class="header-label" style="margin-top:15px;">Status</div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="changeVal('hp', -1)">-</button>
                    <div class="bar-bg"><div id="bar_hp" class="bar-fill hp-fill"></div><div class="bar-values"><input type="number" id="hp_at" value="10"> / <input type="number" id="hp_max" value="10"></div></div>
                    <button class="btn-math" onclick="changeVal('hp', 1)">+</button>
                </div>
            </div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="changeVal('mp', -1)">-</button>
                    <div class="bar-bg"><div id="bar_mp" class="bar-fill mp-fill"></div><div class="bar-values"><input type="number" id="mp_at" value="10"> / <input type="number" id="mp_max" value="10"></div></div>
                    <button class="btn-math" onclick="changeVal('mp', 1)">+</button>
                </div>
            </div>
            <div class="bar-container">
                <div class="bar-controls">
                    <button class="btn-math" onclick="changeVal('pa', -1)">-</button>
                    <div class="bar-bg"><div id="bar_pa" class="bar-fill pa-fill"></div><div class="bar-values"><input type="number" id="pa_at" value="3"> / <input type="number" id="pa_max" value="3"></div></div>
                    <button class="btn-math" onclick="changeVal('pa', 1)">+</button>
                </div>
            </div>
            <div style="text-align:center; margin: 10px 0;"><span class="skull" id="skull1" onclick="toggleSkull('skull1')">üíÄ</span><span class="skull" id="skull2" onclick="toggleSkull('skull2')">üíÄ</span><span class="skull" id="skull3" onclick="toggleSkull('skull3')">üíÄ</span></div>
            <div class="attr-container">
                <div class="attr-box"><input type="number" id="poder" value="0"><div>PODER</div></div>
                <div class="attr-box"><input type="number" id="habilidade" value="0"><div>HAB.</div></div>
                <div class="attr-box"><input type="number" id="resistencia" value="0"><div>RES.</div></div>
            </div>
            <div class="header-label">Per√≠cias</div>
            <div class="pericia-row"><span>ANIMAIS</span><input type="number" id="p_animais" value="0"></div>
            <div class="pericia-row"><span>ARTE</span><input type="number" id="p_arte" value="0"></div>
            <div class="pericia-row"><span>ESPORTE</span><input type="number" id="p_esporte" value="0"></div>
            <div class="pericia-row"><span>INFLU√äNCIA</span><input type="number" id="p_influencia" value="0"></div>
            <div class="pericia-row"><span>LUTA</span><input type="number" id="p_luta" value="0"></div>
            <div class="pericia-row"><span>MANHA</span><input type="number" id="p_manha" value="0"></div>
            <div class="pericia-row"><span>M√ÅQUINAS</span><input type="number" id="p_maquinas" value="0"></div>
            <div class="pericia-row"><span>MEDICINA</span><input type="number" id="p_medicina" value="0"></div>
            <div class="pericia-row"><span>M√çSTICA</span><input type="number" id="p_mistica" value="0"></div>
            <div class="pericia-row"><span>PERCEP√á√ÉO</span><input type="number" id="p_percepcao" value="0"></div>
            <div class="pericia-row"><span>SABER</span><input type="number" id="p_saber" value="0"></div>
            <div class="pericia-row"><span>SOBREVIV√äNCIA</span><input type="number" id="p_sobrevivencia" value="0"></div>
        </div>
    </div>

    <div class="col">
        <div class="card">
            <div class="header-label">Habilidades Gerais</div>
            <label>Vantagens <button class="btn-add" onclick="addItem('vantagens')">+</button></label>
            <div id="list_vantagens" style="margin-top:5px;"></div>
            <label style="margin-top:10px;">Arqu√©tipo <button class="btn-add" onclick="addItem('arquetipo_hab')">+</button></label>
            <div id="list_arquetipo_hab" style="margin-top:5px;"></div>
            <label style="margin-top:10px;">Artefatos <button class="btn-add" onclick="addItem('artefatos')">+</button></label>
            <div id="list_artefatos" style="margin-top:5px;"></div>
            <label style="margin-top:10px;">T√©cnicas <button class="btn-add" onclick="addItem('tecnicas')">+</button></label>
            <div id="list_tecnicas" style="margin-top:5px;"></div>
        </div>
    </div>

    <div class="col">
        <div class="card">
            <div class="header-label">A√ß√µes e Deslocamento</div>
            <div class="marker-section">
                <label style="text-align:center; display:block; color:cyan;">A√á√ïES (Tri√¢ngulos)</label>
                <div class="marker-controls">
                    <button class="btn-count" onclick="updateMarkerCount('a√ß√µes', -1)">-</button>
                    <span id="count_a√ß√µes" style="font-weight:bold; color:cyan;">3</span>
                    <button class="btn-count" onclick="updateMarkerCount('a√ß√µes', 1)">+</button>
                </div>
                <div id="display_a√ß√µes" class="marker-display"></div>
            </div>
            <hr style="border:0; border-top:1px solid #5a1a1f; margin: 20px 0;">
            <div class="marker-section">
                <label style="text-align:center; display:block; color:springgreen;">DESLOCAMENTO (C√≠rculos)</label>
                <div class="marker-controls">
                    <button class="btn-count" onclick="updateMarkerCount('desloc', -1)">-</button>
                    <span id="count_desloc" style="font-weight:bold; color:springgreen;">9</span>
                    <button class="btn-count" onclick="updateMarkerCount('desloc', 1)">+</button>
                </div>
                <div id="display_desloc" class="marker-display"></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, update, onValue, remove, push, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const urlParams = new URLSearchParams(window.location.search);
    const fichaID = urlParams.get('p') || "personagem_padrao";

    // --- LISTA VIP: Somente estes campos ser√£o sincronizados ---
    // Isso evita que campos errados do banco atrapalhem a interface
    const camposParaSalvar = [
        'char_name', 'idade', 'florins', 'arquetipo',
        // Status
        'hp_at', 'hp_max', 'mp_at', 'mp_max', 'pa_at', 'pa_max',
        // Atributos
        'poder', 'habilidade', 'resistencia',
        // Per√≠cias
        'p_animais', 'p_arte', 'p_esporte', 'p_influencia', 'p_luta', 
        'p_manha', 'p_maquinas', 'p_medicina', 'p_mistica', 
        'p_percepcao', 'p_saber', 'p_sobrevivencia'
    ];

    // --- SALVAMENTO UNIVERSAL (DIGITA√á√ÉO) ---
    document.addEventListener('input', (e) => {
        const target = e.target;
        
        // Verifica se o campo est√° na nossa "Lista VIP" ou se √© um campo de texto de habilidade
        if (camposParaSalvar.includes(target.id)) {
            const updates = {};
            updates[target.id] = target.value;
            
            console.log("Salvando:", target.id, target.value); // Debug no console
            update(ref(db, 'fichas/' + fichaID), updates);

            // Atualiza barra visual se necess√°rio
            if (target.id.includes('_at') || target.id.includes('_max')) {
                updateBarVisual(target.id.split('_')[0]);
            }
        }
    });

    // --- CARREGAMENTO DO BANCO DE DADOS ---
    onValue(ref(db, 'fichas/' + fichaID), (snapshot) => {
        const dados = snapshot.val();
        if (!dados) return;

        // 1. Carrega apenas os campos da Lista VIP (Ignora lixo)
        camposParaSalvar.forEach(id => {
            if (dados[id] !== undefined) {
                const el = document.getElementById(id);
                // S√≥ atualiza se o usu√°rio N√ÉO estiver digitando neste campo agora
                if (el && document.activeElement !== el) {
                    el.value = dados[id];
                    // Atualiza barras visuais
                    if (id.includes('_at') || id.includes('_max')) {
                        updateBarVisual(id.split('_')[0]);
                    }
                }
            }
        });

        // 2. Carrega Imagem
        if (dados.char_img) {
            document.getElementById('avatar_display').style.backgroundImage = `url(${dados.char_img})`;
        }
        
        // 3. Carrega Caveiras
        ['skull1', 'skull2', 'skull3'].forEach(sid => {
            const el = document.getElementById(sid);
            if(dados[sid] === "active") el.classList.add('active');
            else el.classList.remove('active');
        });

        // 4. Carrega Habilidades Complexas
        if(dados.habilidades) {
            ['vantagens', 'arquetipo_hab', 'artefatos', 'tecnicas'].forEach(cat => renderHabs(cat, dados.habilidades[cat]));
        }

        // 5. Carrega Marcadores
        if(dados.marcadores) {
            renderMarkers('a√ß√µes', dados.marcadores['a√ß√µes']?.total, dados.marcadores['a√ß√µes']?.pontos);
            renderMarkers('desloc', dados.marcadores['desloc']?.total, dados.marcadores['desloc']?.pontos);
        } else {
            renderMarkers('a√ß√µes', 3, null);
            renderMarkers('desloc', 9, null);
        }
    });

    // --- FUN√á√ïES DE BOT√ïES (+ e -) ---
    window.changeVal = (type, mod) => {
        const el = document.getElementById(type + '_at');
        const maxEl = document.getElementById(type + '_max');
        
        let current = parseInt(el.value) || 0;
        let max = parseInt(maxEl.value) || 0;
        let newVal = current + mod;

        if (newVal < 0) newVal = 0;
        if (newVal > max) newVal = max;

        el.value = newVal; // Atualiza visual na hora
        console.log("Bot√£o clicado:", type, newVal);
        update(ref(db, 'fichas/' + fichaID), { [type + '_at']: newVal });
        updateBarVisual(type);
    };

    function updateBarVisual(type) {
        const at = parseInt(document.getElementById(type + '_at').value) || 0;
        const max = parseInt(document.getElementById(type + '_max').value) || 1;
        const percent = Math.min(Math.max((at / max) * 100, 0), 100);
        const el = document.getElementById('bar_' + type);
        if (el) el.style.width = percent + '%';
    }

    // --- OUTRAS FUN√á√ïES (MANTIDAS) ---
    window.updateMarkerCount = (type, mod) => {
        const span = document.getElementById('count_' + type);
        let count = (parseInt(span.innerText) || 0) + mod;
        if(count < 0) count = 0;
        update(ref(db, `fichas/${fichaID}/marcadores/${type}`), { total: count });
    };

    window.togglePoint = (type, index) => {
        const key = `p_${index}`;
        const current = document.getElementById(`${type}_${index}`).classList.contains('active');
        update(ref(db, `fichas/${fichaID}/marcadores/${type}/pontos`), { [key]: !current });
    };

    function renderMarkers(type, total, pontos) {
        const container = document.getElementById('display_' + type);
        const countSpan = document.getElementById('count_' + type);
        container.innerHTML = "";
        countSpan.innerText = total || (type === 'a√ß√µes' ? 3 : 9);
        const icon = type === 'a√ß√µes' ? '‚ñ≤' : '‚óè';
        const css = type === 'a√ß√µes' ? 'tri' : 'circ';
        for(let i=0; i < (total || (type === 'a√ß√µes' ? 3 : 9)); i++) {
            const isActive = pontos && pontos[`p_${i}`] === true;
            container.innerHTML += `<span id="${type}_${i}" class="marker-item ${css} ${isActive ? 'active' : ''}" onclick="togglePoint('${type}', ${i})">${icon}</span>`;
        }
    }

    // Fun√ß√µes de Habilidade (Vantagens, etc)
    window.addItem = (category) => {
        const newItemRef = push(ref(db, `fichas/${fichaID}/habilidades/${category}`));
        set(newItemRef, { titulo: "", teste: "", desc: "" });
    };
    window.removeItem = (category, id) => { if(confirm("Apagar?")) remove(ref(db, `fichas/${fichaID}/habilidades/${category}/${id}`)); };
    window.toggleHab = (id) => { document.getElementById('body_' + id).classList.toggle('open'); };
    
    // Listener espec√≠fico para inputs de habilidade (porque eles s√£o criados dinamicamente)
    window.saveHab = (cat, id, field, val) => { 
        update(ref(db, `fichas/${fichaID}/habilidades/${cat}/${id}`), { [field]: val }); 
    };

    function renderHabs(category, data) {
        const container = document.getElementById('list_' + category);
        if(!container) return; container.innerHTML = "";
        if(!data) return;
        Object.keys(data).forEach(id => {
            const item = data[id];
            const div = document.createElement('div');
            div.className = 'hab-item';
            div.innerHTML = `<div class="hab-header"><span class="hab-toggle" onclick="toggleHab('${id}')">‚ñº</span><input type="text" class="hab-title" value="${item.titulo || ''}" onchange="saveHab('${category}','${id}','titulo',this.value)" placeholder="Nome"><input type="text" class="hab-dice" value="${item.teste || ''}" onchange="saveHab('${category}','${id}','teste',this.value)" placeholder="Teste"><button class="btn-del" onclick="removeItem('${category}','${id}')">‚úñ</button></div><div class="hab-body" id="body_${id}"><textarea onchange="saveHab('${category}','${id}','desc',this.value)" placeholder="Descri√ß√£o...">${item.desc || ''}</textarea></div>`;
            container.appendChild(div);
        });
    }

    window.toggleSkull = (id) => {
        const el = document.getElementById(id);
        el.classList.toggle('active');
        update(ref(db, 'fichas/' + fichaID), { [id]: el.classList.contains('active') ? "active" : "inactive" });
    };

    document.getElementById('img_upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            const b64 = reader.result;
            document.getElementById('avatar_display').style.backgroundImage = `url(${b64})`;
            update(ref(db, 'fichas/' + fichaID), { char_img: b64 });
        };
        if (file) reader.readAsDataURL(file);
    });
</script>

</body>
</html>
