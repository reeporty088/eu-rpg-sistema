<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha RPG - Jogador</title>
    <style>
        :root { --bg-color: #121212; --card-bg: #1e1e1e; --accent-color: #800000; --text-color: #ffffff; --input-bg: #333; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .sheet-container { width: 100%; max-width: 800px; background-color: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.7); border: 2px solid #333; position: relative; }
        
        /* HEADER */
        .header { display: flex; flex-wrap: wrap; gap: 20px; border-bottom: 2px solid var(--accent-color); padding-bottom: 20px; margin-bottom: 20px; }
        .char-img { width: 120px; height: 120px; background-color: #000; border: 2px solid var(--accent-color); border-radius: 50%; overflow: hidden; background-size: cover; background-position: center; position: relative; cursor: pointer; }
        .char-img input { position: absolute; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .header-info { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.8em; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }
        .input-group input { background: transparent; border: none; border-bottom: 1px solid #555; color: white; font-size: 1.1em; padding: 5px; outline: none; }
        .input-group input:focus { border-bottom-color: var(--accent-color); }

        /* ATRIBUTOS */
        .attributes { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; background: #181818; padding: 15px; border-radius: 10px; }
        .attr-box { text-align: center; border: 1px solid #444; padding: 10px; border-radius: 8px; background: #222; }
        .attr-label { display: block; font-weight: bold; color: var(--accent-color); font-size: 1.2em; margin-bottom: 5px; }
        .attr-val { width: 50px; text-align: center; font-size: 1.5em; background: transparent; border: none; color: white; font-weight: bold; }

        /* BARRAS */
        .bars-section { margin-bottom: 20px; }
        .bar-container { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .bar-label { width: 30px; font-weight: bold; }
        .bar-track { flex-grow: 1; height: 20px; background: #333; border-radius: 10px; overflow: hidden; position: relative; border: 1px solid #555; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-fill { background: #d32f2f; } .mp-fill { background: #1976d2; } .pa-fill { background: #7b1fa2; }
        .bar-inputs { display: flex; gap: 5px; align-items: center; }
        .bar-inputs input { width: 40px; text-align: center; background: #222; border: 1px solid #444; color: white; border-radius: 5px; }

        /* LISTAS (Vantagens, etc) */
        .section-title { color: var(--accent-color); border-bottom: 1px solid #444; margin-top: 20px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btn-add { background: var(--accent-color); border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        .item-list { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .item-card { background: #252525; padding: 10px; border-radius: 5px; border-left: 3px solid var(--accent-color); display: flex; flex-direction: column; position: relative; }
        .item-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; }
        .item-cost { color: #aaa; font-size: 0.8em; }
        .item-desc { font-size: 0.8em; color: #ccc; white-space: pre-wrap; }
        .btn-del { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #555; cursor: pointer; }
        .btn-del:hover { color: red; }

        /* XP e Checkbox */
        .xp-container { display: flex; justify-content: space-between; align-items: center; background: #111; padding: 10px; border-radius: 5px; margin-top: 20px; border: 1px solid #444; }
        .ability-toggle { margin-top: 10px; padding: 10px; background: #222; border: 1px solid #444; border-radius: 5px; display: none; }
        .ability-toggle.visible { display: block; }
        .ability-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        /* === MODAIS (Popups) === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        
        /* Modal de Escolha (Criar vs Lista) */
        .modal-choice { background: var(--card-bg); padding: 20px; border-radius: 10px; border: 1px solid var(--accent-color); width: 300px; text-align: center; }
        .btn-choice { width: 100%; padding: 15px; margin: 5px 0; background: #333; border: 1px solid #555; color: white; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.2s; }
        .btn-choice:hover { background: var(--accent-color); }

        /* Modal de Biblioteca */
        .modal-library { background: var(--card-bg); width: 90%; max-width: 500px; height: 80vh; border-radius: 10px; border: 1px solid var(--accent-color); display: flex; flex-direction: column; overflow: hidden; }
        .lib-header { padding: 15px; background: var(--accent-color); font-weight: bold; text-align: center; }
        .lib-search { padding: 10px; background: #111; border-bottom: 1px solid #444; }
        .lib-search input { width: 100%; padding: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        .lib-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .lib-item { background: #252525; padding: 10px; margin-bottom: 8px; border-radius: 5px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
        .lib-item:hover { border-color: var(--accent-color); background: #303030; }
        .lib-item h4 { margin: 0; color: #ffaaaa; }
        .lib-item span { font-size: 11px; color: #aaa; }
        .lib-close { padding: 10px; background: #333; border: none; color: white; cursor: pointer; width: 100%; font-weight: bold; }

    </style>
</head>
<body>

    <div class="sheet-container">
        <div class="header">
            <div class="char-img" id="char_img_div">
                <input type="file" id="upload_img" accept="image/*">
            </div>
            <div class="header-info">
                <div class="input-group"><label>Nome</label><input type="text" id="char_name"></div>
                <div class="input-group"><label>Arqu√©tipo</label><input type="text" id="char_class"></div>
                <div class="input-group"><label>Jogador</label><input type="text" id="player_name"></div>
            </div>
        </div>

        <div class="attributes">
            <div class="attr-box"><label class="attr-label">POD</label><input type="number" id="attr_pod" class="attr-val" onchange="saveData()"></div>
            <div class="attr-box"><label class="attr-label">HAB</label><input type="number" id="attr_hab" class="attr-val" onchange="saveData()"></div>
            <div class="attr-box"><label class="attr-label">RES</label><input type="number" id="attr_res" class="attr-val" onchange="saveData()"></div>
        </div>

        <div class="bars-section">
            <div class="bar-container">
                <span class="bar-label" style="color:#d32f2f">PV</span>
                <div class="bar-track"><div class="bar-fill hp-fill" id="bar_hp"></div></div>
                <div class="bar-inputs">
                    <input type="number" id="hp_at" onchange="updateBars()">/
                    <input type="number" id="hp_max" onchange="updateBars()">
                </div>
            </div>
            <div class="bar-container">
                <span class="bar-label" style="color:#1976d2">PM</span>
                <div class="bar-track"><div class="bar-fill mp-fill" id="bar_mp"></div></div>
                <div class="bar-inputs">
                    <input type="number" id="mp_at" onchange="updateBars()">/
                    <input type="number" id="mp_max" onchange="updateBars()">
                </div>
            </div>
            <div class="bar-container">
                <span class="bar-label" style="color:#7b1fa2">PA</span>
                <div class="bar-track"><div class="bar-fill pa-fill" id="bar_pa"></div></div>
                <div class="bar-inputs">
                    <input type="number" id="pa_at" onchange="updateBars()">/
                    <input type="number" id="pa_max" onchange="updateBars()">
                </div>
            </div>
        </div>

        <h3 class="section-title">Vantagens <button class="btn-add" onclick="openAddMenu('vantagens')">+</button></h3>
        <div id="list_vantagens" class="item-list"></div>

        <h3 class="section-title">Desvantagens <button class="btn-add" onclick="openAddMenu('desvantagens')">+</button></h3>
        <div id="list_desvantagens" class="item-list"></div>

        <h3 class="section-title">Habilidades de Arqu√©tipo <button class="btn-add" onclick="openAddMenu('habilidades')">+</button></h3>
        <div id="list_habilidades" class="item-list"></div>

        <h3 class="section-title">Artefatos/Itens <button class="btn-add" onclick="openAddMenu('artefatos')">+</button></h3>
        <div id="list_artefatos" class="item-list"></div>

        <div class="xp-container">
            <div>XP Total: <span id="xp_total" style="color:#ffd700; font-weight:bold;">0</span></div>
            <div>Pontos de Evolu√ß√£o: <span id="xp_pontos" style="color:#00ff00; font-weight:bold;">0</span></div>
        </div>

        <div id="special_abilities" class="ability-toggle">
            <h4 style="margin-top:0; color:#ffaa00; text-align:center;">Poderes Ocultos</h4>
            <div class="ability-row">
                <span>üé≠ M√°scara Lunar</span>
                <input type="checkbox" id="check_mask" onchange="toggleAbility('mask')">
            </div>
            <div class="ability-row">
                <span>üòà Chamado do Inferno</span>
                <input type="checkbox" id="check_hell" onchange="toggleAbility('hell')">
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-choice" onclick="closeModal('modal-choice')">
        <div class="modal-choice" onclick="event.stopPropagation()">
            <h3 style="margin-top:0">Adicionar...</h3>
            <button class="btn-choice" onclick="selectFromLibrary()">üìú Selecionar da Lista</button>
            <button class="btn-choice" onclick="createManual()">‚úèÔ∏è Criar Manualmente</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-library">
        <div class="modal-library">
            <div class="lib-header" id="lib-title">BIBLIOTECA</div>
            <div class="lib-search">
                <input type="text" id="lib-search-input" placeholder="Buscar..." onkeyup="filterLibrary()">
            </div>
            <div class="lib-list" id="lib-list-container">
                </div>
            <button class="lib-close" onclick="closeModal('modal-library')">FECHAR</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, update, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCvxxwfsonP5a45nbcz34cxYhXaWBZVhwQ",
        authDomain: "ed-rpg---sistema-de-fichas.firebaseapp.com",
        databaseURL: "https://ed-rpg---sistema-de-fichas-default-rtdb.firebaseio.com",
        projectId: "ed-rpg---sistema-de-fichas",
        storageBucket: "ed-rpg---sistema-de-fichas.firebasestorage.app",
        messagingSenderId: "350999444010",
        appId: "1:350999444010:web:d89f31d13e449b8fbfa153"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ID DA FICHA (Pego da URL ?p=ID)
    const urlParams = new URLSearchParams(window.location.search);
    const playerID = urlParams.get('p');

    if (!playerID) {
        document.body.innerHTML = "<h1 style='color:white'>Erro: ID da ficha n√£o fornecido na URL (?p=...)</h1>";
    }

    // Vari√°veis Globais de Estado
    let currentCategory = ""; // 'vantagens', 'desvantagens', etc.
    let libraryData = {}; // Cache da biblioteca

    // --- CARREGAR FICHA ---
    const fichaRef = ref(db, 'fichas/' + playerID);
    
    onValue(fichaRef, (snapshot) => {
        const data = snapshot.val();
        if(!data) return;

        // Inputs b√°sicos
        if(document.activeElement.tagName !== "INPUT") { // Evita overwrite enquanto digita
            setVal('char_name', data.char_name);
            setVal('char_class', data.char_class);
            setVal('player_name', data.player_name);
            setVal('attr_pod', data.pod);
            setVal('attr_hab', data.habilidade); // Usei habilidade no BD, mas id hab
            setVal('attr_res', data.resistencia);
            
            setVal('hp_at', data.hp_at); setVal('hp_max', data.hp_max);
            setVal('mp_at', data.mp_at); setVal('mp_max', data.mp_max);
            setVal('pa_at', data.pa_at); setVal('pa_max', data.pa_max);
        }

        // Imagem
        if(data.char_img) {
            document.getElementById('char_img_div').style.backgroundImage = `url('${data.char_img}')`;
        }

        // Listas
        renderList('vantagens', data.vantagens);
        renderList('desvantagens', data.desvantagens);
        renderList('habilidades', data.habilidades);
        renderList('artefatos', data.artefatos);

        // XP
        document.getElementById('xp_total').innerText = data.xp_total || 0;
        document.getElementById('xp_pontos').innerText = data.xp_pontos || 0;

        // Poderes Especiais
        const unlocked = data.unlocked_abilities || {};
        const active = data.active_abilities || {};
        const container = document.getElementById('special_abilities');
        
        if (unlocked.mask || unlocked.hell) {
            container.classList.add('visible');
            document.getElementById('check_mask').parentElement.style.display = unlocked.mask ? 'flex' : 'none';
            document.getElementById('check_hell').parentElement.style.display = unlocked.hell ? 'flex' : 'none';
            
            document.getElementById('check_mask').checked = active.mask || false;
            document.getElementById('check_hell').checked = active.hell || false;
        } else {
            container.classList.remove('visible');
        }

        updateBarsUI();
    });

    function setVal(id, val) { if(val !== undefined) document.getElementById(id).value = val; }

    // --- SALVAR DADOS B√ÅSICOS ---
    const inputs = ['char_name', 'char_class', 'player_name', 'attr_pod', 'attr_hab', 'attr_res', 'hp_at', 'hp_max', 'mp_at', 'mp_max', 'pa_at', 'pa_max'];
    inputs.forEach(id => {
        document.getElementById(id).addEventListener('change', saveData);
    });

    window.saveData = () => {
        const updates = {
            char_name: document.getElementById('char_name').value,
            char_class: document.getElementById('char_class').value,
            player_name: document.getElementById('player_name').value,
            pod: document.getElementById('attr_pod').value,
            habilidade: document.getElementById('attr_hab').value,
            resistencia: document.getElementById('attr_res').value,
            hp_at: document.getElementById('hp_at').value, hp_max: document.getElementById('hp_max').value,
            mp_at: document.getElementById('mp_at').value, mp_max: document.getElementById('mp_max').value,
            pa_at: document.getElementById('pa_at').value, pa_max: document.getElementById('pa_max').value,
        };
        update(fichaRef, updates);
        updateBarsUI();
    };

    window.updateBars = () => { saveData(); };

    function updateBarsUI() {
        const setBar = (type) => {
            const at = parseInt(document.getElementById(type+'_at').value) || 0;
            const max = parseInt(document.getElementById(type+'_max').value) || 1;
            const pct = Math.min((at/max)*100, 100);
            document.getElementById('bar_'+type).style.width = pct + '%';
        };
        setBar('hp'); setBar('mp'); setBar('pa');
    }

    // --- IMAGEM ---
    document.getElementById('upload_img').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (re) => {
            const imgBase64 = re.target.result; // Em produ√ß√£o, ideal √© Storage, mas Base64 funciona para pequeno porte
            update(fichaRef, { char_img: imgBase64 });
        };
        reader.readAsDataURL(file);
    });

    // --- SISTEMA DE LISTAS ---
    
    // Passo 1: Abrir Menu de Op√ß√µes
    window.openAddMenu = (category) => {
        currentCategory = category;
        document.getElementById('modal-choice').classList.add('open');
    };

    window.closeModal = (id) => {
        document.getElementById(id).classList.remove('open');
    };

    // Op√ß√£o A: Criar Manualmente (Comportamento Antigo)
    window.createManual = () => {
        closeModal('modal-choice');
        const nome = prompt("Nome:");
        if (!nome) return;
        const custo = prompt("Custo/Tipo:");
        const desc = prompt("Descri√ß√£o:");
        
        push(ref(db, `fichas/${playerID}/${currentCategory}`), {
            nome: nome, custo: custo, desc: desc
        });
    };

    // Op√ß√£o B: Selecionar da Biblioteca (Novo!)
    window.selectFromLibrary = () => {
        closeModal('modal-choice');
        const modalLib = document.getElementById('modal-library');
        modalLib.classList.add('open'); // Abre modal s√≥ depois de fechar o outro
        
        document.getElementById('lib-title').innerText = "BIBLIOTECA: " + currentCategory.toUpperCase();
        document.getElementById('lib-list-container').innerHTML = "<div style='color:#aaa; text-align:center'>Carregando...</div>";
        document.getElementById('lib-search-input').value = ""; // Limpa busca

        // Carrega do Firebase
        onValue(ref(db, `biblioteca_habilidades/${currentCategory}`), (snap) => {
            libraryData = snap.val() || {};
            window.filterLibrary(); // Renderiza
        }, { onlyOnce: true });
    };

    window.filterLibrary = () => {
        const term = document.getElementById('lib-search-input').value.toLowerCase();
        const container = document.getElementById('lib-list-container');
        container.innerHTML = "";

        const items = [];
        for(let id in libraryData) items.push(libraryData[id]);
        
        // Ordena
        items.sort((a,b) => a.nome.localeCompare(b.nome));

        if(items.length === 0) {
            container.innerHTML = "<div style='padding:10px; color:#666; text-align:center;'>Nenhum item cadastrado nesta categoria pelo mestre.</div>";
            return;
        }

        items.forEach(item => {
            if(item.nome.toLowerCase().includes(term)) {
                const div = document.createElement('div');
                div.className = 'lib-item';
                div.innerHTML = `<h4>${item.nome}</h4><span>${item.custo || ''}</span>`;
                div.onclick = () => {
                    // Adiciona √† ficha
                    push(ref(db, `fichas/${playerID}/${currentCategory}`), {
                        nome: item.nome,
                        custo: item.custo,
                        desc: item.desc
                    });
                    closeModal('modal-library');
                };
                container.appendChild(div);
            }
        });
    };

    window.delItem = (category, id) => {
        if(confirm("Remover item?")) {
            remove(ref(db, `fichas/${playerID}/${category}/${id}`));
        }
    };

    function renderList(category, data) {
        const list = document.getElementById('list_' + category);
        list.innerHTML = "";
        if(!data) return;

        Object.keys(data).forEach(key => {
            const item = data[key];
            const div = document.createElement('div');
            div.className = 'item-card';
            div.innerHTML = `
                <div class="item-header"><span>${item.nome}</span><span class="item-cost">${item.custo||''}</span></div>
                <div class="item-desc">${item.desc||''}</div>
                <button class="btn-del" onclick="delItem('${category}', '${key}')">‚úñ</button>
            `;
            list.appendChild(div);
        });
    }

    // --- HABILIDADES ESPECIAIS (Toggle) ---
    window.toggleAbility = (type) => {
        const val = document.getElementById('check_' + type).checked;
        update(ref(db, `fichas/${playerID}/active_abilities/${type}`), val);
    };

</script>
</body>
</html>
